CREATE OR REPLACE VIEW VW_PEDIDOS_NOTAS3 AS
SELECT
    NF.NUMERONF,
    NF.SERIENF,
    NF.SEQPESSOA,
    P.NOMERAZAO AS NomeRazao,
    NF.NROEMPRESA,
    NF.CODGERALOPER,
    NF.DTARECEBIMENTO,
    NF.TIPNOTAFISCAL,
    PV.NROPEDVENDA,
    PV.NROPEDCLIENTE,

    -- Subquery retorna o valor do único item do pedido
    (SELECT VLREMBINFORMADO
     FROM MAD_PEDVENDAITEM
     WHERE NROPEDVENDA = PV.NROPEDVENDA
     AND ROWNUM = 1) AS VLR_COBRADO,

    CASE
        WHEN PV.NROPEDCLIENTE IS NOT NULL THEN 'Sim'
        ELSE 'Não'
    END AS Cobrado,

    CASE
       WHEN Pv.SITUACAOPED = 'F' THEN 'Faturado'
       WHEN Pv.SITUACAOPED = 'C' THEN 'ISENTO'
       WHEN Pv.SITUACAOPED = 'L' THEN 'Não Pago'
       ELSE 'Sem pagamento'
    END AS Pagamento

FROM MLF_NOTAFISCAL NF
LEFT JOIN MAD_PEDVENDA PV
    ON REGEXP_LIKE(PV.NROPEDCLIENTE, 
       '^CP_' || NF.NROEMPRESA || '_' || NF.SEQPESSOA || '.*(^|_)' || NF.NUMERONF || '(_|,)', 'i')
    AND (PV.SITUACAOPED <> 'C' OR PV.Motcancelamento= 'Valor COBRANCA MENOR QUE 0.01')
LEFT JOIN GE_PESSOA P
    ON NF.SEQPESSOA = P.SEQPESSOA

WHERE 0=0
      AND NF.DTARECEBIMENTO BETWEEN TO_DATE('01/01/2025', 'DD/MM/YYYY')
                           AND TO_DATE('05/05/2025', 'DD/MM/YYYY')
  AND NF.CODGERALOPER NOT IN (650, 517, 484, 425, 430, 197, 461, 528)
  AND NF.NROEMPRESA=20
  AND P.NOMERAZAO NOT LIKE '%ZAFFARI%'
;
